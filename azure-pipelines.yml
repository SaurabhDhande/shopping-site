trigger:
- main

resources:
- repo: self

variables:
  dockerHubRepo: saurabhdhande6@gmail.com  # ðŸ‘ˆ change this to your Docker Hub username
  tag: '$(Build.BuildId)'

stages:
- stage: BuildAndPush
  displayName: Build and Push images
  jobs:
  - job: Docker
    displayName: Build and Push
    pool:
      vmImage: 'ubuntu-latest'
    steps:
    - task: Docker@2
      displayName: Login to Docker Hub
      inputs:
        command: login
        containerRegistry: DockerHub   # ðŸ‘ˆ service connection name

    # ---------------- Cart Service ----------------
    - task: Docker@2
      displayName: Build cart-service image
      inputs:
        command: build
        repository: $(dockerHubRepo)/cart-service
        dockerfile: '$(Build.SourcesDirectory)/cart-service/Dockerfile'
        tags: |
          latest
          $(tag)

    - task: Docker@2
      displayName: Push cart-service image
      inputs:
        command: push
        repository: $(dockerHubRepo)/cart-service
        tags: |
          latest
          $(tag)

    # ---------------- Homepage Service ----------------
    - task: Docker@2
      displayName: Build homepage-service image
      inputs:
        command: build
        repository: $(dockerHubRepo)/homepage-service
        dockerfile: '$(Build.SourcesDirectory)/homepage-service/Dockerfile'
        tags: |
          latest
          $(tag)

    - task: Docker@2
      displayName: Push homepage-service image
      inputs:
        command: push
        repository: $(dockerHubRepo)/homepage-service
        tags: |
          latest
          $(tag)
